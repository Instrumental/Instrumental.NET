#!/bin/bash
set -e
cd "$(dirname "$0")/.."

if [[ $(ls bin/Instrumental*.nupkg) ]] && [ "$1" == "lazy" ]; then
  exit
fi

# check dependencies
which mono > /dev/null || (echo "mono must be installed"; exit 1)
which mcs > /dev/null  || (echo "mcs must be installed"; exit 1)

script/nuget install vendor/packages.config -o vendor
mkdir -p bin
pwd
references="vendor/Common.Logging.Core.2.2.0/lib/net40/Common.Logging.Core.dll"
mcs -sdk:45 \
  -recurse:'Instrumental.NET/*.cs' \
  -r:$references \
  -target:library \
  -out:bin/Instrumental.dll \
  -doc:bin/Instrumental.xml \
  -platform:anycpu

internalversion=$(monodis --assembly bin/Instrumental.dll | grep Version)
echo Internal assembly version is $internalversion
script/nuget pack Instrumental.nuspec -OutputDirectory bin/

link=`echo $references | sed 's/,/ /g' | sed -E 's/ System\..*\.dll//'`
mono vendor/ILRepack.exe /internalize /out:bin/InstrumentalWithDependencies.dll bin/Instrumental.dll $link
